<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>غرفة الاستشارة | شـــووور</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; overflow: hidden; }
        .timer-glow { animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100">

    <div class="max-w-2xl mx-auto h-screen flex flex-col shadow-2xl bg-white relative">
        
        <div class="bg-blue-900 text-white p-4 flex justify-between items-center z-10 border-b border-blue-800">
            <div class="flex items-center gap-3">
                <div class="bg-orange-500 p-2 rounded-lg">
                    <span id="timer" class="font-black text-lg tracking-tighter">30:00</span>
                </div>
                <div>
                    <h1 id="chat-title" class="font-bold text-sm">محادثة الاستشارة</h1>
                    <div class="flex items-center gap-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full timer-glow"></span>
                        <p class="text-[9px] text-blue-200 uppercase">جلسة نشطة الآن</p>
                    </div>
                </div>
            </div>
            <button onclick="confirmExit()" class="text-xs bg-white/10 hover:bg-red-600 border border-white/20 px-4 py-2 rounded-xl transition-all">إنهاء الجلسة</button>
        </div>

        <div id="safety-bar" class="bg-orange-50 p-3 text-center border-b border-orange-100 text-orange-800 text-[10px] font-bold">
            ⚠️ المحادثة مراقبة. تنتهي الجلسة تلقائياً عند انتهاء الوقت.
        </div>

        <div id="chat-container" class="flex-grow w-full relative bg-slate-50">
            <div id="loading-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-20">
                <div class="w-12 h-12 border-4 border-blue-900 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-sm font-bold text-blue-900">جاري إعداد غرفة آمنة...</p>
            </div>
            
            <iframe 
                id="chat-frame"
                src="" 
                style="border:none; width:100%; height:100%; display:none;" 
                allowTransparency="true"
                allow="geolocation; microphone; camera; display-capture">
            </iframe>
        </div>

        <div class="p-2 text-center text-slate-400 text-[9px] font-bold bg-white border-t flex justify-center gap-4">
            <span>&copy; شـــووور 2025</span>
            <span class="text-blue-900">نظام تشفير متطور</span>
        </div>
    </div>

    <script>
        let totalSeconds = 30 * 60;
        const timerElement = document.getElementById('timer');
        const chatFrame = document.getElementById('chat-frame');
        const loadingScreen = document.getElementById('loading-screen');
        const chatTitle = document.getElementById('chat-title');

        // --- وظيفة استخراج اسم الخبير من الرابط ---
        function getExpertName() {
            const params = new URLSearchParams(window.location.search);
            return params.get('expert') || "عام";
        }

        function startTimer() {
            const interval = setInterval(() => {
                let minutes = Math.floor(totalSeconds / 60);
                let seconds = totalSeconds % 60;
                timerElement.innerText = 
                    `${minutes < 10 ? '0' + minutes : minutes}:${seconds < 10 ? '0' + seconds : seconds}`;

                if (totalSeconds <= 0) {
                    clearInterval(interval);
                    endSession();
                } else {
                    totalSeconds--;
                    if (totalSeconds < 120) timerElement.parentElement.classList.replace('bg-orange-500', 'bg-red-600');
                }
            }, 1000);
        }

        window.onload = () => {
            const expertName = getExpertName();
            chatTitle.innerText = `استشارة مع: ${expertName}`;

            // --- ربط المحادثة بغرفة خاصة بالخبير ---
            // نقوم بإضافة اسم الخبير كـ "روم" (Room) داخل Minnit Chat
            const minnitChatURL = `https://minnit.chat/PublicChat?embed&nickname=&room=${encodeURIComponent(expertName)}`;
            chatFrame.src = minnitChatURL;

            setTimeout(() => {
                loadingScreen.style.display = 'none';
                chatFrame.style.display = 'block';
                startTimer();
            }, 2000);
        }

        function endSession() {
            alert("انتهى الوقت المحدد للاستشارة. شكراً لاستخدامك شـــووور.");
            window.location.href = "index.html";
        }

        function confirmExit() {
            if(confirm("هل أنت متأكد من إنهاء الجلسة؟ لن تتمكن من العودة إلا بطلب جديد.")) {
                window.location.href = "index.html";
            }
        }
    </script>
</body>
</html>
